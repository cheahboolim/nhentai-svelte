import type { PageServerLoad } from './$types';
import { createClient } from '@libsql/client';
import { env } from '$env/dynamic/private';

// Initialize Turso client
const turso = createClient({
	url: env.TURSO_DATABASE_URL!,
	authToken: env.TURSO_AUTH_TOKEN!
});

export const load: PageServerLoad = async () => {
	try {
		// Simple test: get first 10 manga with basic info
		const result = await turso.execute(`
			SELECT id, slug, title, description, total_views 
			FROM manga 
			ORDER BY total_views DESC 
			LIMIT 10
		`);

		const manga = result.rows.map(row => ({
			id: Number(row.id) || 0,
			slug: String(row.slug) || '',
			title: String(row.title) || 'Untitled',
			description: String(row.description) || '',
			totalViews: Number(row.total_views) || 0
		}));

		return {
			manga,
			success: true,
			meta: {
				title: 'SusManga | Database Test',
				description: 'Testing database connection'
			}
		};

	} catch (error) {
		console.error('Database connection error:', error);
		
		return {
			manga: [],
			success: false,
			error: error instanceof Error ? error.message : 'Unknown error',
			meta: {
				title: 'SusManga | Connection Error',
				description: 'Database connection failed'
			}
		};
	}
};